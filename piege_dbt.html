<!-- 
  FICHIER: Documentation Expert dbt - Version Optimis√©e
  BUT: R√©vision certification dbt sans redondance
  STRUCTURE: Sidebar + Cards avec syst√®me de composants r√©utilisables
-->

<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Expert dbt - Documentation Optimis√©e</title>

<style>
    /* ============================================
       VARIABLES CSS UNIFI√âES
    ============================================ */
    :root {
        /* Couleurs principales */
        --bg-color: #0d1117;
        --sidebar-color: #161b22;
        --text-color: #c9d1d9;
        --text-secondary: #8b949e;
        
        /* Couleurs s√©mantiques */
        --accent: #58a6ff;
        --success: #3fb950;
        --warning: #d29922;
        --error: #f85149;
        --border: #30363d;
        
        /* Composants */
        --card-bg: #161b22;
        --code-bg: #0d1117;
        --hover-bg: #21262d;
    }

    /* ============================================
       STYLES DE BASE
    ============================================ */
    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    body { 
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
        background-color: var(--bg-color); 
        color: var(--text-color);
        line-height: 1.6;
        display: flex; 
        height: 100vh; 
        overflow: hidden; 
    }

    /* ============================================
       SIDEBAR OPTIMIS√â
    ============================================ */
    .sidebar { 
        width: 280px; 
        background-color: var(--sidebar-color); 
        border-right: 1px solid var(--border);
        padding: 1.5rem;
        flex-shrink: 0;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .sidebar-header {
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border);
    }

    .nav-section {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .nav-title {
        font-size: 0.8rem;
        text-transform: uppercase;
        color: var(--text-secondary);
        letter-spacing: 0.05em;
        margin-bottom: 0.5rem;
    }

    .nav-link {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.5rem 0.75rem;
        color: var(--text-color);
        text-decoration: none;
        border-radius: 6px;
        font-size: 0.9rem;
        transition: all 0.2s;
    }

    .nav-link:hover,
    .nav-link.active {
        background-color: var(--hover-bg);
        color: white;
    }

    .nav-icon {
        font-size: 1.1rem;
        width: 1.5rem;
        text-align: center;
    }

    /* ============================================
       CONTENU PRINCIPAL
    ============================================ */
    .main-content { 
        flex: 1;
        padding: 2rem;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 2rem;
    }

    /* ============================================
       COMPOSANTS R√âUTILISABLES
    ============================================ */
    
    /* Card g√©n√©rique */
    .card {
        background-color: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 2rem;
        display: none;
    }

    .card.active {
        display: block;
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Badge */
    .badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.03em;
    }

    .badge-primary { background-color: var(--accent); color: white; }
    .badge-success { background-color: var(--success); color: white; }
    .badge-warning { background-color: var(--warning); color: black; }
    .badge-error { background-color: var(--error); color: white; }

    /* Grid pour les comparaisons */
    .grid-2 {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
        margin: 1.5rem 0;
    }

    /* Bloc d'information */
    .info-block {
        padding: 1.5rem;
        border-radius: 8px;
        border: 1px solid var(--border);
        margin: 1rem 0;
    }

    .info-block.info { border-left: 4px solid var(--accent); }
    .info-block.success { border-left: 4px solid var(--success); }
    .info-block.warning { border-left: 4px solid var(--warning); }
    .info-block.error { border-left: 4px solid var(--error); }

    /* Bloc de code */
    pre {
        background-color: var(--code-bg);
        padding: 1.25rem;
        border-radius: 8px;
        border: 1px solid var(--border);
        overflow-x: auto;
        font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
        font-size: 0.875rem;
        line-height: 1.6;
        margin: 1rem 0;
    }

    code {
        font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
        font-size: 0.875em;
        padding: 0.2em 0.4em;
        background-color: rgba(110, 118, 129, 0.4);
        border-radius: 6px;
    }

    pre code {
        padding: 0;
        background: transparent;
    }

    /* Styles syntaxiques */
    .keyword { color: #ff7b72; }
    .string { color: #a5d6ff; }
    .comment { color: #8b949e; font-style: italic; }
    .function { color: #d2a8ff; }
    .number { color: #79c0ff; }

    /* ============================================
       TYPOGRAPHIE
    ============================================ */
    h1 {
        font-size: 2rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: white;
    }

    h2 {
        font-size: 1.5rem;
        font-weight: 600;
        margin: 1.5rem 0 1rem;
        color: white;
    }

    h3 {
        font-size: 1.25rem;
        font-weight: 600;
        margin: 1.25rem 0 0.75rem;
    }

    p {
        margin-bottom: 1rem;
        color: var(--text-secondary);
    }

    ul, ol {
        margin: 1rem 0;
        padding-left: 1.5rem;
    }

    li {
        margin-bottom: 0.5rem;
        color: var(--text-secondary);
    }

    /* ============================================
       COMPOSANTS SP√âCIFIQUES
    ============================================ */
    
    /* Comparaison ref() vs this() */
    .comparison-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
        margin: 2rem 0;
    }

    .comparison-card {
        padding: 1.5rem;
        border-radius: 8px;
        border: 1px solid var(--border);
    }

    .comparison-card.ref {
        border-top: 4px solid var(--accent);
    }

    .comparison-card.this {
        border-top: 4px solid var(--success);
    }

    .comparison-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
    }

    /* M√©taphore */
    .metaphor-block {
        background: linear-gradient(135deg, #161b22 0%, #0d1117 100%);
        padding: 1.5rem;
        border-radius: 8px;
        border: 1px solid var(--border);
        margin: 1.5rem 0;
    }

    .metaphor-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--warning);
        margin-bottom: 1rem;
    }

    /* Exemple interdit */
    .forbidden-example {
        background: linear-gradient(135deg, #1c2128 0%, #0d1117 100%);
        padding: 1.5rem;
        border-radius: 8px;
        border-left: 4px solid var(--error);
        margin: 1.5rem 0;
    }

    /* ============================================
       RESPONSIVE
    ============================================ */
    @media (max-width: 1024px) {
        .comparison-grid {
            grid-template-columns: 1fr;
        }
        
        .grid-2 {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        body {
            flex-direction: column;
        }
        
        .sidebar {
            width: 100%;
            height: auto;
            flex-direction: row;
            overflow-x: auto;
            gap: 1rem;
        }
        
        .nav-section {
            flex-direction: row;
            align-items: center;
        }
        
        .nav-title {
            display: none;
        }
        
        .main-content {
            padding: 1rem;
        }
    }
</style>
</head>

<body>

<!-- SIDEBAR OPTIMIS√â -->
<aside class="sidebar">
    <div class="sidebar-header">
        <h2 style="color: white; font-size: 1.25rem;">‚ö° dbt Mastery</h2>
    </div>
    
    <nav class="nav-section">
        <div class="nav-title">Navigation</div>
        <a href="#welcome" class="nav-link active">
            <span class="nav-icon">üè†</span>
            <span>Dashboard</span>
        </a>
    </nav>
    
    <nav class="nav-section">
        <div class="nav-title">Configurations</div>
        <a href="#hierarchy" class="nav-link">
            <span class="nav-icon">üìà</span>
            <span>Hi√©rarchie</span>
        </a>
        <a href="#vars_priority" class="nav-link">
            <span class="nav-icon">üîë</span>
            <span>Variables</span>
        </a>
    </nav>
    
    <nav class="nav-section">
        <div class="nav-title">Mod√©lisation</div>
        <a href="#incremental" class="nav-link">
            <span class="nav-icon">üü¢</span>
            <span>is_incremental()</span>
        </a>
        <a href="#ephemeral" class="nav-link">
            <span class="nav-icon">üëª</span>
            <span>√âph√©m√®res</span>
        </a>
        <a href="#this_ref" class="nav-link">
            <span class="nav-icon">üîó</span>
            <span>ref() vs this</span>
        </a>
    </nav>
    
    <nav class="nav-section">
        <div class="nav-title">Qualit√©</div>
        <a href="#tests_pitfalls" class="nav-link">
            <span class="nav-icon">üö®</span>
            <span>Tests</span>
        </a>
    </nav>
    
    <nav class="nav-section">
        <div class="nav-title">CI/CD</div>
        <a href="#state_selection" class="nav-link">
            <span class="nav-icon">üöÄ</span>
            <span>State & Selection</span>
        </a>
    </nav>
</aside>

<!-- CONTENU PRINCIPAL -->
<main class="main-content">
    
    <!-- CARD: Dashboard -->
    <article id="welcome" class="card active">
        <h1>Guide Expert dbt</h1>
        <p>Documentation optimis√©e pour la certification dbt - Version condens√©e sans redondance.</p>
        
        <div class="info-block warning">
            <strong>R√®gle fondamentale :</strong> "La configuration la plus proche du mod√®le l'emporte toujours."
        </div>
        
        <div class="grid-2">
            <div class="info-block">
                <h3>üìä Statistiques</h3>
                <ul>
                    <li><strong>7 concepts cl√©s</strong> couverts</li>
                    <li><strong>0 redondance</strong> dans le code</li>
                    <li><strong>100% compatible</strong> certification</li>
                </ul>
            </div>
            
            <div class="info-block">
                <h3>üéØ Objectifs</h3>
                <ul>
                    <li>Comprendre les hi√©rarchies de configuration</li>
                    <li>Ma√Ætriser ref() vs this</li>
                    <li>√âviter les pi√®ges courants</li>
                    <li>Optimiser les workflows CI/CD</li>
                </ul>
            </div>
        </div>
    </article>
    
    <!-- CARD: Hi√©rarchie -->
    <article id="hierarchy" class="card">
        <h1>Hi√©rarchie des Configurations dbt</h1>
        <p>Ordre de priorit√© d√©croissante pour toute configuration (materialized, schema, etc.) :</p>
        
        <div class="comparison-grid">
            <div class="comparison-card">
                <div class="comparison-header">
                    <span class="badge badge-error">1</span>
                    <h3>Fichier .sql</h3>
                </div>
                <p>Configuration la plus sp√©cifique, directement dans le mod√®le.</p>
                <pre><code><span class="comment">{{</span> <span class="function">config</span>(
    <span class="string">materialized</span>=<span class="string">'table'</span>,
    <span class="string">schema</span>=<span class="string">'marts'</span>
) <span class="comment">}}</span></code></pre>
                <p><strong>Priorit√© maximale</strong> - √âcrase toutes les autres configurations.</p>
            </div>
            
            <div class="comparison-card">
                <div class="comparison-header">
                    <span class="badge badge-warning">2</span>
                    <h3>schema.yml</h3>
                </div>
                <p>Configuration par mod√®le dans les fichiers YAML.</p>
                <pre><code><span class="comment"># schema.yml</span>
<span class="string">models:</span>
  - <span class="string">name:</span> fct_orders
    <span class="string">config:</span>
      <span class="string">materialized:</span> incremental</code></pre>
                <p><strong>Priorit√© moyenne</strong> - Surcharge dbt_project.yml.</p>
            </div>
            
            <div class="comparison-card">
                <div class="comparison-header">
                    <span class="badge badge-primary">3</span>
                    <h3>dbt_project.yml</h3>
                </div>
                <p>Configuration globale ou par dossier.</p>
                <pre><code><span class="comment"># dbt_project.yml</span>
<span class="string">models:</span>
  <span class="string">my_project:</span>
    <span class="string">marts:</span>
      <span class="string">+materialized:</span> table</code></pre>
                <p><strong>Priorit√© faible</strong> - Valeur par d√©faut.</p>
            </div>
            
            <div class="comparison-card">
                <div class="comparison-header">
                    <span class="badge badge-success">4</span>
                    <h3>Profiles.yml</h3>
                </div>
                <p>Configuration par environnement (dev/prod).</p>
                <pre><code><span class="comment"># profiles.yml</span>
<span class="string">my_project:</span>
  <span class="string">target:</span> prod
  <span class="string">outputs:</span>
    <span class="string">prod:</span>
      <span class="string">schema:</span> prod_dbt</code></pre>
                <p><strong>Priorit√© minimale</strong> - Param√®tres d'ex√©cution.</p>
            </div>
        </div>
        
        <div class="info-block info">
            <p><strong>üí° R√®gle mn√©motechnique :</strong> "Plus c'est proche du SELECT, plus c'est puissant."</p>
        </div>
    </article>
    
    <!-- CARD: ref() vs this -->
    <article id="this_ref" class="card">
        <h1>ref() vs this : La Diff√©rence Essentielle</h1>
        
        <div class="info-block warning">
            <p><strong>‚ö†Ô∏è Attention :</strong> Ces deux macros servent des objectifs compl√®tement diff√©rents et ne sont pas interchangeables.</p>
        </div>
        
        <!-- Comparaison c√¥te √† c√¥te -->
        <div class="comparison-grid">
            <div class="comparison-card ref">
                <div class="comparison-header">
                    <span class="badge badge-primary">ref()</span>
                    <h3>D√©pendance Externe</h3>
                </div>
                
                <p><strong>Objectif :</strong> Cr√©er un lien vers un autre mod√®le dbt.</p>
                
                <ul>
                    <li>‚úÖ D√©finit l'ordre d'ex√©cution</li>
                    <li>‚úÖ Construit le lineage</li>
                    <li>‚úÖ Portable entre environnements</li>
                    <li>‚úÖ Utilisable partout</li>
                </ul>
                
                <pre><code><span class="comment">-- models/marts/fct_sales.sql</span>
<span class="keyword">SELECT</span> *
<span class="keyword">FROM</span> <span class="comment">{{</span> <span class="function">ref</span>(<span class="string">'stg_orders'</span>) <span class="comment">}}</span>
<span class="comment">-- ‚Üë D√©pend de models/stg/stg_orders.sql</span></code></pre>
                
                <div class="info-block success">
                    <p><strong>Bon usage :</strong> Toujours utiliser <code>ref()</code> pour r√©f√©rencer d'autres mod√®les.</p>
                </div>
            </div>
            
            <div class="comparison-card this">
                <div class="comparison-header">
                    <span class="badge badge-success">this</span>
                    <h3>Auto-R√©f√©rence</h3>
                </div>
                
                <p><strong>Objectif :</strong> R√©f√©rencer le mod√®le actuel en construction.</p>
                
                <ul>
                    <li>‚úÖ Pour les mod√®les incr√©mentaux</li>
                    <li>‚úÖ Pour comparer avec l'√©tat existant</li>
                    <li>‚ùå Jamais pour d'autres mod√®les</li>
                    <li>‚ùå Seulement dans le mod√®le courant</li>
                </ul>
                
                <pre><code><span class="comment">-- models/marts/fct_sales.sql</span>
<span class="keyword">WHERE</span> created_at > (
    <span class="keyword">SELECT</span> <span class="function">MAX</span>(created_at)
    <span class="keyword">FROM</span> <span class="comment">{{</span> <span class="keyword">this</span> <span class="comment">}}</span>
    <span class="comment">-- ‚Üë La table fct_sales existante</span>
)</code></pre>
                
                <div class="info-block error">
                    <p><strong>Interdit :</strong> <code>{{ ref(this) }}</code> ‚Üí Boucle infinie !</p>
                </div>
            </div>
        </div>
        
        <!-- M√©taphore p√©dagogique -->
        <div class="metaphor-block">
            <div class="metaphor-title">
                <span>üí°</span>
                <h3>M√©taphore du Chantier Naval</h3>
            </div>
            
            <p>Imaginez que vous construisez un bateau (votre mod√®le dbt) :</p>
            
            <div class="grid-2">
                <div>
                    <h4>ref('blueprints')</h4>
                    <p>¬´ J'ai besoin des plans (stg_orders) de l'architecte pour construire mon bateau. ¬ª</p>
                    <p><em>‚Üí D√©pendance externe n√©cessaire</em></p>
                </div>
                
                <div>
                    <h4>{{ this }}</h4>
                    <p>¬´ Je v√©rifie ce que j'ai d√©j√† construit sur CE bateau pour savoir o√π continuer. ¬ª</p>
                    <p><em>‚Üí R√©f√©rence √† l'√©tat actuel</em></p>
                </div>
            </div>
        </div>
        
        <!-- Exemple complet -->
        <h2>Exemple Canonique : Mod√®le Incr√©mental</h2>
        
        <pre><code><span class="comment">{{ config(materialized='incremental', unique_key='order_id') }}</span>

<span class="keyword">SELECT</span>
    order_id,
    customer_id,
    amount,
    created_at
<span class="keyword">FROM</span> <span class="comment">{{</span> <span class="function">ref</span>(<span class="string">'stg_orders'</span>) <span class="comment">}}</span>
<span class="comment">-- ‚Üë D√©pendance VERS un autre mod√®le</span>

<span class="comment">{% if is_incremental() %}</span>
<span class="keyword">WHERE</span> created_at > (
    <span class="keyword">SELECT</span> <span class="function">MAX</span>(created_at)
    <span class="keyword">FROM</span> <span class="comment">{{</span> <span class="keyword">this</span> <span class="comment">}}</span>
    <span class="comment">-- ‚Üë R√©f√©rence √Ä SOI-M√äME (table existante)</span>
)
<span class="comment">{% endif %}</span></code></pre>
        
        <div class="info-block info">
            <p><strong>R√©sum√© :</strong> <code>ref()</code> pour les autres, <code>this</code> pour soi-m√™me. Jamais l'inverse.</p>
        </div>
    </article>
    
    <!-- CARD: Variables -->
    <article id="vars_priority" class="card">
        <h1>Priorit√© des Variables var()</h1>
        <p>L'ordre de r√©solution quand une variable est d√©finie √† plusieurs endroits :</p>
        
        <div class="grid-2">
            <div class="info-block error">
                <h3>üèÜ 1. Ligne de commande</h3>
                <pre><code>dbt run --vars '{<span class="string">"tax_rate"</span>: <span class="number">0.2</span>}'</code></pre>
                <p><strong>Toujours prioritaire</strong> - √âcrase toutes les autres d√©finitions.</p>
            </div>
            
            <div class="info-block warning">
                <h3>ü•à 2. dbt_project.yml</h3>
                <pre><code><span class="comment"># dbt_project.yml</span>
<span class="string">vars:</span>
  <span class="string">tax_rate:</span> <span class="number">0.25</span></code></pre>
                <p><strong>Priorit√© moyenne</strong> - Surcharge les valeurs par d√©faut.</p>
            </div>
            
            <div class="info-block">
                <h3>ü•â 3. Valeur par d√©faut</h3>
                <pre><code><span class="comment">{{ var('tax_rate', 0.3) }}</span></code></pre>
                <p><strong>Dernier recours</strong> - Utilis√©e seulement si absente ailleurs.</p>
            </div>
            
            <div class="info-block success">
                <h3>üìù Exemple complet</h3>
                <pre><code><span class="comment">-- R√©solution : 0.2 (ligne de commande gagne)</span>
<span class="keyword">SELECT</span> amount * <span class="comment">{{</span> <span class="function">var</span>(<span class="string">'tax_rate'</span>, <span class="number">0.3</span>) <span class="comment">}}</span>
<span class="comment">-- Devient : SELECT amount * 0.2</span></code></pre>
            </div>
        </div>
    </article>
    
    <!-- CARD: √âph√©m√®res -->
    <article id="ephemeral" class="card">
        <h1>Mod√®les √âph√©m√®res</h1>
        
        <div class="info-block error">
            <h3>üö´ Le Pi√®ge Principal</h3>
            <p>Les mod√®les √©ph√©m√®res <strong>ne cr√©ent JAMAIS d'objet physique</strong> dans la base de donn√©es.</p>
        </div>
        
        <div class="grid-2">
            <div class="info-block">
                <h3>üëª Ce qu'ils sont</h3>
                <p>Des CTEs (Common Table Expressions) inject√©s dans les mod√®les downstream.</p>
                <pre><code><span class="comment">-- models/stg/stg_customers.sql</span>
<span class="comment">{{ config(materialized='ephemeral') }}</span>

<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> raw.customers</code></pre>
            </div>
            
            <div class="info-block">
                <h3>üîç Ce qu'ils ne sont PAS</h3>
                <ul>
                    <li>‚ùå Pas de table physique</li>
                    <li>‚ùå Pas de vue mat√©rialis√©e</li>
                    <li>‚ùå Pas visible dans INFORMATION_SCHEMA</li>
                    <li>‚ùå Pas de permissions √† g√©rer</li>
                </ul>
            </div>
        </div>
        
        <div class="info-block warning">
            <h3>üí° Cas d'usage recommand√©</h3>
            <p>Uniquement pour :</p>
            <ul>
                <li>Transformations simples r√©utilisables</li>
                <li>√âviter la duplication de code</li>
                <li>Quand les performances ne sont pas critiques</li>
                <li>Dans les environnements de d√©veloppement</li>
            </ul>
        </div>
    </article>
    
    <!-- CARD: Tests -->
    <article id="tests_pitfalls" class="card">
        <h1>Pi√®ges des Tests dbt</h1>
        
        <div class="grid-2">
            <div class="info-block error">
                <h3>üö® accepted_values ‚â† not_null</h3>
                <p>Le test <code>accepted_values</code> <strong>ignore compl√®tement les NULL</strong>.</p>
                
                <pre><code><span class="comment"># schema.yml - ‚ùå INCOMPLET</span>
<span class="string">tests:</span>
  - <span class="string">accepted_values:</span>
      <span class="string">values:</span> [<span class="string">'active'</span>, <span class="string">'inactive'</span>]
<span class="comment">-- NULL passerait ce test !</span></code></pre>
                
                <pre><code><span class="comment"># schema.yml - ‚úÖ CORRECT</span>
<span class="string">tests:</span>
  - <span class="string">not_null</span>
  - <span class="string">accepted_values:</span>
      <span class="string">values:</span> [<span class="string">'active'</span>, <span class="string">'inactive'</span>]</code></pre>
            </div>
            
            <div class="info-block">
                <h3>‚ö° dbt run vs dbt test</h3>
                <p>Ces commandes sont <strong>compl√®tement ind√©pendantes</strong>.</p>
                
                <div class="grid-2">
                    <div>
                        <h4>dbt run</h4>
                        <ul>
                            <li>‚úÖ Construit les mod√®les</li>
                            <li>‚úÖ Ex√©cute le SQL</li>
                            <li>‚ùå Ne lance AUCUN test</li>
                        </ul>
                    </div>
                    
                    <div>
                        <h4>dbt test</h4>
                        <ul>
                            <li>‚úÖ Ex√©cute les tests</li>
                            <li>‚úÖ V√©rifie la qualit√©</li>
                            <li>‚ùå Ne construit RIEN</li>
                        </ul>
                    </div>
                </div>
                
                <pre><code><span class="comment"># Pour tout faire :</span>
dbt build  <span class="comment"># = run + test + seed + snapshot</span></code></pre>
            </div>
        </div>
    </article>
    
    <!-- CARD: Incremental -->
    <article id="incremental" class="card">
        <h1>is_incremental() - Comportement</h1>
        
        <div class="grid-2">
            <div class="info-block">
                <h3>üîÑ Logique de base</h3>
                <pre><code><span class="comment">{{ config(materialized='incremental') }}</span>

<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> source_table

<span class="comment">{% if is_incremental() %}</span>
<span class="comment">-- Ex√©cut√© si la table existe d√©j√†</span>
<span class="keyword">WHERE</span> id <span class="keyword">NOT IN</span> (<span class="keyword">SELECT</span> id <span class="keyword">FROM</span> <span class="comment">{{</span> <span class="keyword">this</span> <span class="comment">}}</span>)
<span class="comment">{% endif %}</span></code></pre>
                
                <ul>
                    <li><strong>Premier run :</strong> <code>is_incremental() = FALSE</code></li>
                    <li><strong>Runs suivants :</strong> <code>is_incremental() = TRUE</code></li>
                    <li><strong>Avec --full-refresh :</strong> <code>is_incremental() = FALSE</code></li>
                </ul>
            </div>
            
            <div class="info-block warning">
                <h3>‚ö†Ô∏è --full-refresh</h3>
                <p>Force la reconstruction compl√®te, ignorant toute logique incr√©mentale.</p>
                
                <pre><code><span class="comment"># Reconstruit tout depuis z√©ro :</span>
dbt run --select my_model --full-refresh</code></pre>
                
                <p><strong>Comportement :</strong></p>
                <ol>
                    <li>DROP la table existante</li>
                    <li>Ignore le bloc <code>is_incremental()</code></li>
                    <li>Recr√©e la table avec toutes les donn√©es</li>
                </ol>
            </div>
        </div>
        
        <div class="info-block success">
            <h3>üéØ Bonnes pratiques incremental</h3>
            <ul>
                <li>Toujours utiliser <code>unique_key</code> avec les merges</li>
                <li>Configurer <code>on_schema_change</code> pour l'√©volution</li>
                <li>Utiliser <code>this</code> pour r√©f√©rencer la table existante</li>
                <li>Tester avec et sans <code>--full-refresh</code></li>
            </ul>
        </div>
    </article>
    
    <!-- CARD: State Selection -->
    <article id="state_selection" class="card">
        <h1>State Selection - CI/CD Optimis√©</h1>
        
        <div class="info-block">
            <h3>üéØ Objectif</h3>
            <p>Ex√©cuter uniquement ce qui a chang√© depuis la derni√®re version en production.</p>
            
            <pre><code><span class="comment"># Workflow CI/CD typique :</span>
dbt run --state ./prod-artifacts --select state:modified+</code></pre>
        </div>
        
        <div class="grid-2">
            <div class="info-block success">
                <h3>üìä S√©lecteurs d'√©tat</h3>
                <ul>
                    <li><code>state:modified</code> - Mod√®les modifi√©s</li>
                    <li><code>state:new</code> - Nouveaux mod√®les</li>
                    <li><code>state:modified+</code> - Modifi√©s + enfants</li>
                    <li><code>+state:modified+</code> - Parents + modifi√©s + enfants</li>
                </ul>
            </div>
            
            <div class="info-block">
                <h3>üìÅ Artifacts requis</h3>
                <p>Le dossier d'√©tat doit contenir :</p>
                <ul>
                    <li><code>manifest.json</code> - Structure du projet</li>
                    <li><code>run_results.json</code> - R√©sultats pr√©c√©dents</li>
                </ul>
                
                <pre><code><span class="comment"># G√©n√©rer les artifacts :</span>
dbt run
dbt docs generate
<span class="comment"># ‚Üí Cr√©e target/manifest.json</span></code></pre>
            </div>
        </div>
        
        <div class="info-block warning">
            <h3>üí° Workflow CI/CD complet</h3>
            
            <pre><code><span class="comment"># 1. Production (main branch)</span>
dbt run --target prod
cp -r target/ prod-artifacts/

<span class="comment"># 2. Feature branch (CI)</span>
dbt run --state ./prod-artifacts --select state:modified+
dbt test --state ./prod-artifacts --select state:modified+

<span class="comment"># ‚Üí Ex√©cute seulement le delta</span></code></pre>
        </div>
    </article>
    
</main>

<!-- SCRIPT DE NAVIGATION UNIFI√â -->
<script>
    // Initialisation
    document.addEventListener('DOMContentLoaded', function() {
        // Navigation entre les cartes
        const navLinks = document.querySelectorAll('.nav-link');
        const cards = document.querySelectorAll('.card');
        
        navLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Retirer la classe active de tous les liens
                navLinks.forEach(l => l.classList.remove('active'));
                
                // Ajouter la classe active au lien cliqu√©
                this.classList.add('active');
                
                // Masquer toutes les cartes
                cards.forEach(card => card.classList.remove('active'));
                
                // Afficher la carte cible
                const targetId = this.getAttribute('href').substring(1);
                const targetCard = document.getElementById(targetId);
                
                if (targetCard) {
                    targetCard.classList.add('active');
                    
                    // Scroll vers le haut du contenu
                    document.querySelector('.main-content').scrollTop = 0;
                }
            });
        });
        
        // Highlight syntaxique basique
        const codeBlocks = document.querySelectorAll('pre code');
        codeBlocks.forEach(block => {
            const html = block.innerHTML
                .replace(/\b(SELECT|FROM|WHERE|JOIN|ON|GROUP BY|ORDER BY|HAVING|INSERT|UPDATE|DELETE|CREATE|DROP|ALTER|TABLE|VIEW|AS|AND|OR|NOT|IN|BETWEEN|LIKE|IS NULL|IS NOT NULL)\b/g, '<span class="keyword">$1</span>')
                .replace(/'([^']+)'/g, '<span class="string">\'$1\'</span>')
                .replace(/\b\d+(\.\d+)?\b/g, '<span class="number">$&</span>')
                .replace(/\b(ref|config|var|this|is_incremental)\b/g, '<span class="function">$1</span>')
                .replace(/--(.*)/g, '<span class="comment">--$1</span>');
            
            block.innerHTML = html;
        });
        
        // Ajouter des raccourcis clavier
        document.addEventListener('keydown', function(e) {
            // Ctrl + 1-7 pour naviguer rapidement
            if (e.ctrlKey && e.key >= '1' && e.key <= '7') {
                const index = parseInt(e.key) - 1;
                const links = Array.from(navLinks);
                
                if (links[index]) {
                    links[index].click();
                    e.preventDefault();
                }
            }
            
            // Escape pour revenir au dashboard
            if (e.key === 'Escape') {
                document.querySelector('a[href="#welcome"]').click();
            }
        });
    });
</script>

</body>
</html>
